<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>凱基永續．共築願景 (座標精修版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root {
            --bg-color: #000510;
            --neon-cyan: #00ffff;
            
            /* KGI 品牌色 */
            --kgi-blue: #00479d;   
            --kgi-orange: #f58025; 
            --kgi-green: #5cba46;  
            --kgi-white: #ffffff;  
            --vip-gold: #ffd700;   
            
            /* 格子尺寸 */
            --grid-size: min(8.2vh, 8.2vw); 
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: "Microsoft JhengHei", sans-serif;
            height: 100vh; overflow: hidden;
        }

        /* === 全螢幕震動 === */
        .screen-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 1px, 0); }
            20%, 80% { transform: translate3d(3px, -2px, 0); }
            30%, 50%, 70% { transform: translate3d(-5px, 3px, 0); }
            40%, 60% { transform: translate3d(5px, -4px, 0); }
        }

        #particles-js {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(ellipse at bottom, #0c2441 0%, #000000 80%);
            z-index: 1; overflow: hidden; pointer-events: none;
        }
        .warp-star {
            position: absolute; width: 4px; height: 4px; background: var(--neon-cyan);
            border-radius: 50%; opacity: 0; box-shadow: 0 0 10px var(--neon-cyan);
            animation: warpSpeed var(--duration) linear infinite; animation-delay: var(--delay);
        }
        @keyframes warpSpeed {
            0% { opacity: 0; transform: translateY(0) scale(0.5); }
            10% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-100vh) scale(5); height: 100px; }
        }

        .layout-wrapper { display: flex; width: 100%; height: 100%; position: relative; z-index: 10; }

        .main-display {
            flex: 3; position: relative;
            display: flex; justify-content: center; align-items: center; 
            background-image: linear-gradient(transparent 50%, rgba(0, 0, 0, 0.5) 50%), radial-gradient(transparent, black);
            background-size: 10px 10px, 100% 100%;
            perspective: 1200px; perspective-origin: 50% 90%; 
        }

        .title {
            position: absolute; top: 15px; width: 100%; text-align: center;
            font-size: 3.8rem; color: #ffffff;
            text-shadow: 0 0 10px #00ffff, 0 0 30px var(--kgi-blue), 0 0 70px var(--kgi-blue);
            letter-spacing: 12px; font-weight: 900; z-index: 20;
            animation: titlePulse 2s infinite alternate; pointer-events: none;
        }
        @keyframes titlePulse {
            from { filter: brightness(1); text-shadow: 0 0 20px var(--kgi-blue); }
            to { filter: brightness(1.3); text-shadow: 0 0 50px var(--neon-cyan), 0 0 100px #ffffff; }
        }

        .slogan {
            position: absolute; bottom: 25px; width: 100%; text-align: center;
            font-size: 2.5rem; font-weight: bold; z-index: 20;
            color: #ffffff; text-shadow: 0 0 20px var(--kgi-orange);
            opacity: 0; transition: opacity 1s; pointer-events: none;
        }

        .building-wrapper {
            position: relative; padding: 0; border: none; box-shadow: none; z-index: 10;
            transform: rotateX(15deg) translateY(-10px); transform-style: preserve-3d;
            display: flex; justify-content: center; align-items: center;
        }

        .building-grid { display: grid; gap: 0.5vh; margin: 0 auto; }

        /* === 格子基礎 === */
        .piece {
            width: var(--grid-size); height: var(--grid-size);
            background-color: rgba(0, 15, 30, 0.6);
            border: 1px solid rgba(0, 150, 255, 0.2);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            border-radius: 4px; position: relative;
            animation: unstableEnergy 0.8s infinite alternate steps(5);
            transition: transform 0.3s;
        }
        @keyframes unstableEnergy {
            0% { border-color: rgba(0, 150, 255, 0.2); }
            100% { border-color: rgba(0, 255, 255, 0.4); box-shadow: inset 0 0 10px var(--kgi-blue); }
        }
        .spacer { width: var(--grid-size); height: var(--grid-size); background: transparent; pointer-events: none; }

        .piece.vip-star {
            background-color: rgba(60, 50, 0, 0.8); border: 1px solid rgba(255, 215, 0, 0.3);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            box-shadow: none; transform: scale(1.1);
        }

        .piece.active {
            z-index: 100; transform: scale(1.1) translateZ(6vh); 
            animation: activePlasma 0.5s infinite alternate !important;
            border-width: 0 !important;
        }

        /* === 顏色定義 === */
        .c-blue { background: var(--kgi-blue) !important; box-shadow: 0 0 30px var(--kgi-blue); }
        .c-orange { background: var(--kgi-orange) !important; box-shadow: 0 0 30px var(--kgi-orange); }
        .c-green { background: var(--kgi-green) !important; box-shadow: 0 0 30px var(--kgi-green); }
        .c-white { background: var(--kgi-white) !important; box-shadow: 0 0 30px #ffffff; }

        /* === 特殊斜切定義 (根據您的座標需求) === */
        /* 左下對角線：上藍下橘 (135度) */
        .split-blue-orange-diag { 
            background: linear-gradient(135deg, var(--kgi-blue) 50%, var(--kgi-orange) 50%) !important; 
            box-shadow: 0 0 30px var(--kgi-orange);
        }
        /* 右下對角線：上白下藍 (-135度/225度) */
        .split-white-blue-diag { 
            background: linear-gradient(225deg, var(--kgi-white) 50%, var(--kgi-blue) 50%) !important; 
            box-shadow: 0 0 30px var(--kgi-blue);
        }
        /* 中軸垂直切分：左橘右白 */
        .split-vert-orange-white { 
            background: linear-gradient(to right, var(--kgi-orange) 50%, var(--kgi-white) 50%) !important; 
        }
        /* 中軸水平切分：上藍下白 */
        .split-horz-blue-white {
            background: linear-gradient(to bottom, var(--kgi-blue) 50%, var(--kgi-white) 50%) !important;
        }
        /* 上半部舊有的切分 (維持原樣) */
        .split-blue-green-diag { background: linear-gradient(45deg, var(--kgi-blue) 48%, var(--kgi-green) 52%) !important; }

        .piece.vip-star.active {
            background: #fff !important; 
            filter: drop-shadow(0 0 10px #ffd700) drop-shadow(0 0 30px #ffd700) drop-shadow(0 0 50px orange);
            z-index: 150; transform: scale(1.5) translateZ(10vh);
            animation: starPulse 1s infinite alternate !important;
        }
        @keyframes starPulse { from { filter: drop-shadow(0 0 20px #ffd700); } to { filter: drop-shadow(0 0 50px #ffd700) drop-shadow(0 0 80px white); } }
        @keyframes activePlasma { from { filter: brightness(1); } to { filter: brightness(1.2) contrast(1.1); } }

        .explosion-particle {
            position: absolute; width: 12px; height: 12px; background: #ffffff; border-radius: 50%;
            box-shadow: 0 0 20px var(--color); pointer-events: none; z-index: 9999;
        }
        .massive-shockwave {
            position: absolute; width: 0; height: 0; border-radius: 50%; background: transparent;
            border: 50px solid #ffffff; opacity: 1; transform: translate(-50%, -50%); pointer-events: none; z-index: 9998;
        }

        .sidebar {
            flex: 1; background: rgba(5, 15, 30, 0.85); border-left: 3px solid var(--kgi-blue);
            box-shadow: -20px 0 50px rgba(0, 100, 255, 0.2); display: flex; flex-direction: column; z-index: 50; backdrop-filter: blur(20px);
        }
        .sidebar-header {
            padding: 25px; background: linear-gradient(90deg, var(--kgi-blue), transparent);
            border-bottom: 2px solid var(--neon-cyan); text-align: center; cursor: pointer; user-select: none;
        }
        .sidebar-header h2 {
            margin: 0; color: #ffffff; font-size: 1.8rem; letter-spacing: 3px;
            text-shadow: 0 0 15px var(--kgi-orange); font-style: italic;
        }
        .message-list { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .msg-card {
            background: linear-gradient(110deg, rgba(0, 50, 150, 0.3), rgba(0, 0, 0, 0.5));
            border: 1px solid var(--kgi-blue); border-left: 5px solid var(--kgi-orange);
            border-radius: 4px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; overflow: hidden;
            animation: slideInRight 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .msg-card::before {
            content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg); animation: cardShine 3s infinite;
        }
        @keyframes cardShine { 0% { left: -150%; } 30%, 100% { left: 150%; } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }

        .msg-name { color: var(--neon-cyan); font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; display: flex; justify-content: space-between;}
        .msg-time { color: #aaa; font-size: 0.8rem; }
        .msg-content { font-size: 1.2rem; text-shadow: 1px 1px 2px black; }

        .status-light {
            position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.8); border: 2px solid var(--neon-cyan);
            padding: 10px 20px; border-radius: 30px; z-index: 200; box-shadow: 0 0 20px var(--neon-cyan); font-weight: bold;
        }
        .dot.online { background: #00ff00; box-shadow: 0 0 15px #00ff00; }

        .marquee-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 100;
        }
        .marquee-item {
            position: absolute; white-space: nowrap; font-size: 3rem; color: #fff;
            text-shadow: 0 0 15px var(--kgi-blue), 0 0 30px var(--neon-cyan);
            font-weight: 900; bottom: -100px; padding: 25px 50px;
            background: linear-gradient(90deg, var(--kgi-blue), #000); 
            border: 3px solid #ffffff; border-radius: 60px;
            box-shadow: 0 10px 50px rgba(0, 150, 255, 0.6);
            animation: flyToTop 15s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }
        @keyframes flyToTop {
            0% { bottom: -150px; opacity: 0; transform: scale(0.5) rotate(-5deg); }
            10% { opacity: 1; transform: scale(1.2) rotate(0deg); }
            20% { transform: scale(1); }
            80% { opacity: 1; }
            100% { bottom: 120%; opacity: 0; transform: scale(1.5) translateY(-100px); }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    
    <div class="layout-wrapper">
        <div class="main-display" id="displayArea">
            <div class="status-light"><div class="dot" id="statusDot"></div><span id="statusText">連線系統初始化...</span></div>
            <div class="title">凱基永續．共築願景</div>
            
            <div class="building-wrapper">
                <div class="building-grid" id="building"></div>
            </div>

            <div class="slogan" id="finalSlogan">凝聚每一份祝福，點亮無限未來</div>
            <div class="marquee-container" id="marqueeArea"></div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header" onclick="manualDownloadBackup()">
                <h2 title="連續點擊三次可強制備份下載">⚡ 即時能量祝願 ⚡</h2>
            </div>
            <div class="message-list" id="messageList"></div>
        </div>
    </div>

    <script>
        function createWarpStars() {
            const container = document.getElementById('particles-js');
            for (let i = 0; i < 120; i++) {
                const star = document.createElement('div');
                star.classList.add('warp-star');
                star.style.left = `${Math.random() * 100}%`;
                star.style.setProperty('--duration', `${Math.random() * 3 + 1}s`);
                star.style.setProperty('--delay', `${Math.random() * -5}s`);
                container.appendChild(star);
            }
        }
        createWarpStars();

        const buildingMap = [
            [0,0,0,2,0,2,0,0,0], 
            [0,0,1,1,0,1,1,0,0], 
            [0,1,1,1,0,1,1,1,0], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [0,1,1,0,1,0,1,1,0]
        ];
        
        let totalPieces = 0;
        let filledCount = 0;
        const building = document.getElementById('building');
        const pieces = [];
        const blessingHistory = []; 
        let vipStatus = { chairman: false, gm: false }; 
        let hasAutoDownloaded = false; 
        let clickCount = 0; 

        const kgiColors = {
            orange: '#f58025',
            green: '#5cba46',
            blue: '#00479d',
            white: '#ffffff',
            gold: '#ffd700'
        };

        function initBuilding() {
            building.innerHTML = '';
            const cols = buildingMap[0].length;
            building.style.gridTemplateColumns = `repeat(${cols}, var(--grid-size))`;
            
            buildingMap.forEach((row, rowIndex) => {
                row.forEach((cell, colIndex) => {
                    const div = document.createElement('div');
                    // [修改] 傳入 colIndex, rowIndex 進行精準判斷
                    const colorClass = determineLogoColor(colIndex, rowIndex);
                    div.dataset.colorClass = colorClass;

                    if (cell === 1) {
                        div.classList.add('piece'); 
                        pieces.push(div); building.appendChild(div); totalPieces++;
                    } else if (cell === 2) {
                        div.classList.add('piece', 'vip-star'); 
                        div.dataset.vip = "true"; 
                        pieces.push(div); building.appendChild(div); totalPieces++;
                    } else {
                        div.classList.add('spacer'); building.appendChild(div);
                    }
                });
            });
        }

        // === [核心修正] 9x11 精準坐標強制對應 (Hardcoded Map) ===
        // 依據您的指示，針對特定格子回傳指定的 class
        function determineLogoColor(col, row) {
            
            // 坐標 Key (c,r)
            const key = `${col},${row}`;

            // === 1. 左下對角線 (下橘上藍) ===
            // 坐標: (0,6), (1,7), (2,8), (3,9) => 注意：您的指示 (1,7) 對應代碼 (0,6)
            // (1,7) -> c0,r6
            // (2,8) -> c1,r7
            // (3,9) -> c2,r8
            // (4,10) -> c3,r9
            if (key === '0,6' || key === '1,7' || key === '2,8' || key === '3,9') {
                return 'split-blue-orange-diag'; // 上藍下橘 (CSS: 135deg Blue 50%, Orange 50%)
            }

            // === 2. 純橘色格子 ===
            // (2,7) -> c1,r6
            // (3,8) -> c2,r7
            if (key === '1,6' || key === '2,7') {
                return 'c-orange';
            }

            // === 3. 右下對角線 (下藍上白) ===
            // (9,7) -> c8,r6
            // (8,8) -> c7,r7
            // (7,9) -> c6,r8
            // (6,10) -> c5,r9
            if (key === '8,6' || key === '7,7' || key === '6,8' || key === '5,9') {
                return 'split-white-blue-diag'; // 上白下藍 (CSS: 225deg White 50%, Blue 50%)
            }

            // === 4. 純白色格子 ===
            // (8,7) -> c7,r6
            // (7,8) -> c6,r7
            if (key === '7,6' || key === '6,7') {
                return 'c-white';
            }

            // === 5. 中軸線 (Col 4) 特殊處理 ===
            if (col === 4) {
                // 正中間最底下兩格 -> 純藍 (4,9) (4,10) -> code: c4,r9 & c4,r10
                // 您的指示: "倒數一、二格調整為藍色" (即 Row 9, Row 10)
                if (row >= 9) return 'c-blue';
                // 上半部中軸 -> 純藍
                if (row < 5) return 'c-blue';
                // 正中心點 (Row 5) -> 左橘右白
                if (row === 5) return 'split-vert-orange-white';
                // 下半部其他中軸 (Row 6,7,8) -> 左橘右白 (維持連續性)
                return 'split-vert-orange-white';
            }

            // === 6. 橫向中軸 (Row 5) ===
            if (row === 5) {
                // 左方分線 -> 純橘
                if (col < 4) return 'c-orange';
                // 右方分線 -> 上藍下白
                if (col > 4) return 'split-horz-blue-white';
            }

            // === 7. 其餘區域 (維持四大象限邏輯) ===
            // 左上 (Top-Left)
            if (col < 4 && row < 5) {
                if (col + row <= 3) return 'c-blue';
                if (col + row === 4) return 'split-blue-orange-diag';
                return 'c-orange';
            }
            // 右上 (Top-Right)
            if (col > 4 && row < 5) {
                if ((col - 4) - row >= 1) return 'c-green';
                if ((col - 4) - row === 0) return 'split-blue-green-diag';
                return 'c-blue';
            }
            // 左下 (Bottom-Left) 其餘
            if (col < 4 && row > 5) {
                // 剩下的基本上都是藍色 (三角形下方)
                return 'c-blue';
            }
            // 右下 (Bottom-Right) 其餘
            if (col > 4 && row > 5) {
                // 剩下的基本上都是藍色 (三角形下方)
                return 'c-blue';
            }

            return 'c-blue'; // Default
        }

        function getHexFromClass(className) {
            if (className.includes('orange')) return kgiColors.orange;
            if (className.includes('green')) return kgiColors.green;
            if (className.includes('white')) return kgiColors.white;
            if (className.includes('gold')) return kgiColors.gold;
            return kgiColors.blue; 
        }

        function getRandomEmptyIndex() {
            const emptyIndices = pieces.map((p, index) => {
                if (p.classList.contains('active') || p.dataset.vip === "true") return -1;
                return index;
            }).filter(index => index !== -1);
            if (emptyIndices.length === 0) return -1;
            return emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
        }

        function getVipEmptyIndex() {
            const vipIndices = pieces.map((p, index) => {
                if (p.dataset.vip === "true" && !p.classList.contains('active')) return index;
                return -1;
            }).filter(index => index !== -1);
            if (vipIndices.length === 0) return -1;
            return vipIndices[0]; 
        }

        function triggerEnergyExplosion(targetElement, colorHex) {
            const rect = targetElement.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            document.body.classList.remove('screen-shake');
            void document.body.offsetWidth;
            document.body.classList.add('screen-shake');
            setTimeout(() => document.body.classList.remove('screen-shake'), 500);

            const shockwave = document.createElement('div');
            shockwave.classList.add('massive-shockwave');
            shockwave.style.left = centerX + 'px';
            shockwave.style.top = centerY + 'px';
            shockwave.style.borderColor = colorHex; 
            shockwave.style.boxShadow = `0 0 120px ${colorHex}, inset 0 0 120px ${colorHex}`;
            document.body.appendChild(shockwave);
            
            shockwave.animate([
                { width: '0px', height: '0px', opacity: 1, borderWidth: '50px' },
                { width: '2500px', height: '2500px', opacity: 0, borderWidth: '0px' }
            ], { duration: 900, easing: 'ease-out' }).onfinish = () => shockwave.remove();

            const particleCount = 60;
            const colors = [colorHex, '#ffffff', colorHex];
            for (let i = 0; i < particleCount; i++) {
                const p = document.createElement('div');
                p.classList.add('explosion-particle');
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                p.style.setProperty('--color', p.style.backgroundColor);
                p.style.left = centerX + 'px';
                p.style.top = centerY + 'px';
                document.body.appendChild(p);

                const angle = Math.random() * Math.PI * 2;
                const velocity = 150 + Math.random() * 900; 
                const destX = Math.cos(angle) * velocity;
                const destY = Math.sin(angle) * velocity;
                const rotation = Math.random() * 720;

                p.animate([
                    { transform: `translate(0,0) scale(1) rotate(0deg)`, opacity: 1 },
                    { transform: `translate(${destX}px, ${destY}px) scale(0) rotate(${rotation}deg)`, opacity: 0 }
                ], { duration: 800 + Math.random() * 400, easing: 'cubic-bezier(0.25, 1, 0.5, 1)' }).onfinish = () => p.remove();
            }
        }

        function addToSidebar(name, msg) {
            const list = document.getElementById('messageList');
            const card = document.createElement('div');
            card.classList.add('msg-card');
            const now = new Date();
            card.innerHTML = `<div class="msg-name">${name}<span class="msg-time">${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}</span></div><div class="msg-content">${msg}</div>`;
            list.insertBefore(card, list.firstChild);
        }

        function exportToCSV() {
            if (blessingHistory.length === 0) { alert("無資料可下載"); return; }
            let csvContent = "\uFEFF發送時間,姓名/單位,祝福內容\n";
            blessingHistory.forEach(item => {
                const cleanName = item.name.replace(/,/g, "，");
                const cleanMsg = item.msg.replace(/,/g, "，");
                csvContent += `${item.time},${cleanName},${cleanMsg}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            const timestamp = new Date().toISOString().replace(/[:.]/g, "-").slice(0, 19);
            link.setAttribute("download", `KGI_祝福紀錄_${timestamp}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function manualDownloadBackup() {
            clickCount++;
            if (clickCount === 3) {
                if(confirm("強制下載紀錄？")) exportToCSV();
                clickCount = 0;
            }
            setTimeout(() => { clickCount = 0; }, 2000);
        }

        function onMessageReceived(name, msg) {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0') + ':' + now.getSeconds().toString().padStart(2, '0');
            blessingHistory.push({ time: timeStr, name: name, msg: msg });
            addToSidebar(name, msg);

            if (name.includes("董事長")) vipStatus.chairman = true;
            if (name.includes("總經理")) vipStatus.gm = true;
            if (vipStatus.chairman && vipStatus.gm && !hasAutoDownloaded) {
                setTimeout(() => { exportToCSV(); hasAutoDownloaded = true; }, 3000);
            }

            if (filledCount >= totalPieces) return;

            const isVipUser = name.includes("董事長") || name.includes("總經理");
            let targetIndex = -1;
            let finalColorHex = '#ffffff'; 

            if (isVipUser) {
                targetIndex = getVipEmptyIndex();
                if (targetIndex === -1) targetIndex = getRandomEmptyIndex();
                finalColorHex = kgiColors.gold;
            } else {
                targetIndex = getRandomEmptyIndex();
                if (targetIndex !== -1) {
                    const colorClass = pieces[targetIndex].dataset.colorClass;
                    pieces[targetIndex].classList.add(colorClass);
                    finalColorHex = getHexFromClass(colorClass);
                }
            }

            if (targetIndex !== -1) {
                const targetPiece = pieces[targetIndex];
                targetPiece.classList.add('active');
                filledCount++;
                
                triggerEnergyExplosion(targetPiece, finalColorHex);
                showMarquee(`${name}：${msg}`);

                if (filledCount === totalPieces) {
                    setTimeout(() => {
                        document.getElementById('finalSlogan').style.opacity = 1;
                        triggerCompletionEffect();
                    }, 500);
                }
            }
        }

        function showMarquee(text) {
            const container = document.getElementById('marqueeArea');
            const el = document.createElement('div');
            el.classList.add('marquee-item');
            el.innerText = text;
            const colors = ['#fff', '#ffd700', '#7df9ff', '#ffb74d'];
            el.style.borderColor = colors[Math.floor(Math.random() * colors.length)];
            el.style.left = (5 + Math.random() * 80) + '%';
            container.appendChild(el);
            setTimeout(() => { el.remove(); }, 16000);
        }

        function triggerCompletionEffect() {
            pieces.forEach((p, i) => {
                setTimeout(() => {
                    p.style.transform = 'scale(1.5) translateZ(150px)';
                    p.style.boxShadow = '0 0 100px white, 0 0 150px var(--neon-cyan)';
                    p.style.zIndex = 200;
                    setTimeout(() => {
                        p.style.transform = 'scale(1.2) translateZ(50px)';
                         p.style.boxShadow = '0 0 30px var(--neon-cyan), 0 0 60px var(--kgi-blue)';
                        p.style.zIndex = 100;
                    }, 600);
                }, (i % 9) * 60 + (Math.floor(i / 9) * 30));
            });
             document.querySelector('.title').style.animation = 'none';
             document.querySelector('.title').style.textShadow = '0 0 50px var(--kgi-orange), 0 0 100px var(--kgi-orange)';
        }

        const broker = "broker.emqx.io"; const port = 8084; const topic = "kgi_event_2025_live_demo";
        const clientID = "monitor_" + new Date().getTime();
        const client = new Paho.MQTT.Client(broker, port, clientID);
        client.onConnectionLost = function (res) { document.getElementById('statusDot').classList.remove('online'); document.getElementById('statusText').innerText = "連線中斷..."; setTimeout(connectMQTT, 2000); };
        client.onMessageArrived = function (msg) { try { const data = JSON.parse(msg.payloadString); onMessageReceived(data.name, data.msg); } catch (e) {} };
        function connectMQTT() {
            client.connect({ useSSL: true, onSuccess: function () { document.getElementById('statusDot').classList.add('online'); document.getElementById('statusText').innerText = `系統連線就緒 (${totalPieces}格)`; client.subscribe(topic); }, onFailure: function () {} });
        }
        initBuilding(); connectMQTT();
    </script>
</body>
</html>
