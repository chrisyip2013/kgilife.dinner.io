<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>凱基永續．共築願景 (VIP尊爵版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        :root {
            --bg-color: #000510;
            --kgi-blue: #004a99;
            --kgi-bright-blue: #0080ff;
            --kgi-orange: #ff6600;
            --neon-cyan: #00ffff;
            --neon-white: #ffffff;
            --vip-gold: #ffd700; /* VIP 金色 */
            --sidebar-bg: rgba(3, 10, 20, 0.9);
            
            /* 80格極限尺寸 */
            --grid-size: min(8.2vh, 8.2vw); 
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: "Microsoft JhengHei", sans-serif;
            height: 100vh; 
            overflow: hidden;
        }

        .screen-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 1px, 0); }
            20%, 80% { transform: translate3d(3px, -2px, 0); }
            30%, 50%, 70% { transform: translate3d(-5px, 3px, 0); }
            40%, 60% { transform: translate3d(5px, -4px, 0); }
        }

        #particles-js {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(ellipse at bottom, #0c2441 0%, #000000 80%);
            z-index: 1; overflow: hidden; pointer-events: none;
        }
        .warp-star {
            position: absolute; width: 4px; height: 4px; background: var(--neon-cyan);
            border-radius: 50%; opacity: 0; box-shadow: 0 0 10px var(--neon-cyan);
            animation: warpSpeed var(--duration) linear infinite; animation-delay: var(--delay);
        }
        @keyframes warpSpeed {
            0% { opacity: 0; transform: translateY(0) scale(0.5); }
            10% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-100vh) scale(5); height: 100px; }
        }

        .layout-wrapper {
            display: flex; width: 100%; height: 100%; position: relative; z-index: 10;
        }

        .main-display {
            flex: 3; position: relative;
            display: flex; justify-content: center; align-items: center; 
            background-image: linear-gradient(transparent 50%, rgba(0, 0, 0, 0.5) 50%), radial-gradient(transparent, black);
            background-size: 10px 10px, 100% 100%;
            perspective: 1200px; perspective-origin: 50% 90%; 
        }

        .title {
            position: absolute; top: 15px; width: 100%; text-align: center;
            font-size: 3.8rem; color: var(--neon-white);
            text-shadow: 0 0 10px var(--neon-cyan), 0 0 30px var(--kgi-bright-blue), 0 0 70px var(--kgi-bright-blue);
            letter-spacing: 12px; font-weight: 900; z-index: 20;
            animation: titlePulse 2s infinite alternate; pointer-events: none;
        }
        @keyframes titlePulse {
            from { filter: brightness(1); text-shadow: 0 0 20px var(--kgi-bright-blue); }
            to { filter: brightness(1.3); text-shadow: 0 0 50px var(--neon-cyan), 0 0 100px var(--neon-white); }
        }

        .slogan {
            position: absolute; bottom: 25px; width: 100%; text-align: center;
            font-size: 2.5rem; font-weight: bold; z-index: 20;
            color: var(--neon-white); text-shadow: 0 0 20px var(--kgi-orange);
            opacity: 0; transition: opacity 1s; pointer-events: none;
        }

        .building-wrapper {
            position: relative; padding: 0; border: none; box-shadow: none; z-index: 10;
            transform: rotateX(15deg) translateY(-10px); transform-style: preserve-3d;
            display: flex; justify-content: center; align-items: center;
        }

        .building-grid { display: grid; gap: 0.5vh; margin: 0 auto; }

        /* === 一般格子 === */
        .piece {
            width: var(--grid-size); height: var(--grid-size);
            background-color: rgba(0, 15, 30, 0.6);
            border: 1px solid rgba(0, 150, 255, 0.2);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            border-radius: 6px; position: relative;
            animation: unstableEnergy 0.8s infinite alternate steps(5);
            transition: transform 0.3s;
        }
        .piece:nth-child(odd) { animation-delay: 0.2s; } .piece:nth-child(3n) { animation-duration: 1.2s; } .piece:nth-child(5n) { animation-delay: 0.5s; animation-duration: 0.6s; }
        @keyframes unstableEnergy {
            0% { border-color: rgba(0, 150, 255, 0.2); }
            100% { border-color: rgba(0, 255, 255, 0.4); box-shadow: inset 0 0 10px var(--kgi-bright-blue); }
        }
        .spacer { width: var(--grid-size); height: var(--grid-size); background: transparent; pointer-events: none; }

        /* === [關鍵] VIP 星星樣式 === */
        .piece.vip-star {
            /* 預設為暗金色 */
            background-color: rgba(60, 50, 0, 0.8);
            border: 1px solid rgba(255, 215, 0, 0.3);
            /* 裁切成星星形狀 */
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            box-shadow: none; /* clip-path 會裁切 shadow，改用 drop-shadow 或內部光 */
            transform: scale(1.1); /* 星星稍微大一點 */
        }

        /* === 一般格子激活 === */
        .piece.active {
            background: var(--neon-white) !important;
            border: 2px solid var(--neon-white) !important;
            box-shadow: 0 0 30px var(--neon-cyan), 0 0 60px var(--kgi-bright-blue), 0 0 100px var(--kgi-bright-blue) !important;
            z-index: 100; transform: scale(1.1) translateZ(6vh); 
            animation: activePlasma 0.5s infinite alternate !important;
        }

        /* === [關鍵] VIP 星星激活狀態 (金色光芒) === */
        .piece.vip-star.active {
            background: #fff !important; /* 核心白亮 */
            /* 金色光暈 */
            filter: drop-shadow(0 0 10px var(--vip-gold)) drop-shadow(0 0 30px var(--vip-gold)) drop-shadow(0 0 50px orange);
            z-index: 150;
            transform: scale(1.5) translateZ(10vh); /* 更突出 */
            animation: starPulse 1s infinite alternate !important;
        }
        @keyframes starPulse { from { filter: drop-shadow(0 0 20px var(--vip-gold)); } to { filter: drop-shadow(0 0 50px var(--vip-gold)) drop-shadow(0 0 80px white); } }
        @keyframes activePlasma { from { filter: brightness(1); } to { filter: brightness(1.3) contrast(1.2); } }

        /* === 爆炸特效 === */
        .explosion-particle {
            position: absolute; width: 12px; height: 12px; background: var(--neon-white); border-radius: 50%;
            box-shadow: 0 0 20px var(--color); pointer-events: none; z-index: 9999;
        }
        .massive-shockwave {
            position: absolute; width: 0; height: 0; border-radius: 50%; background: transparent;
            border: 50px solid var(--neon-white); box-shadow: 0 0 120px var(--neon-cyan), inset 0 0 120px var(--neon-cyan);
            opacity: 1; transform: translate(-50%, -50%); pointer-events: none; z-index: 9998;
        }

        /* === 右側側邊欄 === */
        .sidebar {
            flex: 1; background: rgba(5, 15, 30, 0.85); border-left: 3px solid var(--kgi-bright-blue);
            box-shadow: -20px 0 50px rgba(0, 100, 255, 0.2); display: flex; flex-direction: column; z-index: 50; backdrop-filter: blur(20px);
        }
        .sidebar-header {
            padding: 25px; background: linear-gradient(90deg, var(--kgi-blue), transparent);
            border-bottom: 2px solid var(--neon-cyan); text-align: center;
        }
        .sidebar-header h2 {
            margin: 0; color: var(--neon-white); font-size: 1.8rem; letter-spacing: 3px;
            text-shadow: 0 0 15px var(--kgi-orange); font-style: italic;
        }
        .message-list { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
        .msg-card {
            background: linear-gradient(110deg, rgba(0, 50, 150, 0.3), rgba(0, 0, 0, 0.5));
            border: 1px solid var(--kgi-bright-blue); border-left: 5px solid var(--kgi-orange);
            border-radius: 4px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); position: relative; overflow: hidden;
            animation: slideInRight 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .msg-card::before {
            content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-20deg); animation: cardShine 3s infinite;
        }
        @keyframes cardShine { 0% { left: -150%; } 30%, 100% { left: 150%; } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }

        .msg-name { color: var(--neon-cyan); font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; display: flex; justify-content: space-between;}
        .msg-time { color: #aaa; font-size: 0.8rem; }
        .msg-content { font-size: 1.2rem; text-shadow: 1px 1px 2px black; }

        .status-light {
            position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.8); border: 2px solid var(--neon-cyan);
            padding: 10px 20px; border-radius: 30px; z-index: 200; box-shadow: 0 0 20px var(--neon-cyan); font-weight: bold;
        }
        .dot.online { background: #00ff00; box-shadow: 0 0 15px #00ff00; }

        .marquee-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 100;
        }
        .marquee-item {
            position: absolute; white-space: nowrap; font-size: 3rem; color: #fff;
            text-shadow: 0 0 15px var(--kgi-bright-blue), 0 0 30px var(--neon-cyan);
            font-weight: 900; bottom: -100px; padding: 25px 50px;
            background: linear-gradient(90deg, var(--kgi-blue), #000); 
            border: 3px solid var(--neon-white); border-radius: 60px;
            box-shadow: 0 10px 50px rgba(0, 150, 255, 0.6);
            animation: flyToTop 15s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }
        @keyframes flyToTop {
            0% { bottom: -150px; opacity: 0; transform: scale(0.5) rotate(-5deg); }
            10% { opacity: 1; transform: scale(1.2) rotate(0deg); }
            20% { transform: scale(1); }
            80% { opacity: 1; }
            100% { bottom: 120%; opacity: 0; transform: scale(1.5) translateY(-100px); }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    
    <div class="layout-wrapper">
        <div class="main-display" id="displayArea">
            <div class="status-light"><div class="dot" id="statusDot"></div><span id="statusText">連線系統初始化...</span></div>
            <div class="title">凱基永續．共築願景</div>
            
            <div class="building-wrapper">
                <div class="building-grid" id="building"></div>
            </div>

            <div class="slogan" id="finalSlogan">凝聚每一份祝福，點亮無限未來</div>
            <div class="marquee-container" id="marqueeArea"></div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <h2>⚡ 即時能量祝願 ⚡</h2>
            </div>
            <div class="message-list" id="messageList"></div>
        </div>
    </div>

    <script>
        function createWarpStars() {
            const container = document.getElementById('particles-js');
            for (let i = 0; i < 120; i++) {
                const star = document.createElement('div');
                star.classList.add('warp-star');
                star.style.left = `${Math.random() * 100}%`;
                star.style.setProperty('--duration', `${Math.random() * 3 + 1}s`);
                star.style.setProperty('--delay', `${Math.random() * -5}s`);
                container.appendChild(star);
            }
        }
        createWarpStars();

        // === [地圖邏輯] 0=空, 1=普通格, 2=VIP星星 ===
        const buildingMap = [
            [0,0,0,2,0,2,0,0,0], // Row 1: 兩個 2 是天線頂端的星星 (VIP)
            [0,0,1,1,0,1,1,0,0], 
            [0,1,1,1,0,1,1,1,0], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [1,1,1,1,1,1,1,1,1], 
            [0,1,1,0,1,0,1,1,0]
        ];
        
        let totalPieces = 0;
        let filledCount = 0;
        const building = document.getElementById('building');
        const pieces = [];

        function initBuilding() {
            building.innerHTML = '';
            const cols = buildingMap[0].length;
            building.style.gridTemplateColumns = `repeat(${cols}, var(--grid-size))`;
            
            buildingMap.forEach((row) => {
                row.forEach((cell) => {
                    const div = document.createElement('div');
                    if (cell === 1) {
                        div.classList.add('piece'); 
                        pieces.push(div); building.appendChild(div); totalPieces++;
                    } else if (cell === 2) {
                        // VIP 星星邏輯
                        div.classList.add('piece', 'vip-star'); 
                        // 標記為 vip，getRandomEmptyIndex 會自動過濾它
                        div.dataset.vip = "true"; 
                        pieces.push(div); building.appendChild(div); totalPieces++;
                    } else {
                        div.classList.add('spacer'); building.appendChild(div);
                    }
                });
            });
            console.log("Total Pieces:", totalPieces);
        }

        // === 隨機取得空格 (自動過濾掉 VIP 格子) ===
        function getRandomEmptyIndex() {
            const emptyIndices = pieces.map((p, index) => {
                // 如果已經點亮，或它是 VIP 格子，就不能被一般隨機選中
                if (p.classList.contains('active') || p.dataset.vip === "true") return -1;
                return index;
            }).filter(index => index !== -1);

            if (emptyIndices.length === 0) return -1;
            return emptyIndices[Math.floor(Math.random() * emptyIndices.length)];
        }

        // === 取得 VIP 空格 (專供長官使用) ===
        function getVipEmptyIndex() {
            const vipIndices = pieces.map((p, index) => {
                // 找出是 VIP 且還沒亮起的
                if (p.dataset.vip === "true" && !p.classList.contains('active')) return index;
                return -1;
            }).filter(index => index !== -1);
            
            if (vipIndices.length === 0) return -1;
            // 優先填左邊的星星，再填右邊
            return vipIndices[0]; 
        }

        function triggerEnergyExplosion(targetElement, isVip = false) {
            const rect = targetElement.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            document.body.classList.remove('screen-shake');
            void document.body.offsetWidth;
            document.body.classList.add('screen-shake');
            setTimeout(() => document.body.classList.remove('screen-shake'), 500);

            // VIP 使用金色衝擊波，一般人使用白色/青色
            const shockwaveColor = isVip ? '#ffd700' : '#ffffff';
            const shockwaveShadow = isVip ? 'orange' : 'var(--neon-cyan)';

            const shockwave = document.createElement('div');
            shockwave.classList.add('massive-shockwave');
            shockwave.style.left = centerX + 'px';
            shockwave.style.top = centerY + 'px';
            shockwave.style.borderColor = shockwaveColor;
            shockwave.style.boxShadow = `0 0 120px ${shockwaveShadow}, inset 0 0 120px ${shockwaveShadow}`;
            document.body.appendChild(shockwave);
            
            shockwave.animate([
                { width: '0px', height: '0px', opacity: 1, borderWidth: '50px' },
                { width: '2500px', height: '2500px', opacity: 0, borderWidth: '0px' }
            ], { duration: 900, easing: 'ease-out' }).onfinish = () => shockwave.remove();

            const particleCount = isVip ? 80 : 50; // VIP 粒子更多
            const colors = isVip ? ['#ffd700', '#ffcc00', '#ffffff'] : ['#00ffff', '#ffffff', '#0080ff', '#ff6600'];
            
            for (let i = 0; i < particleCount; i++) {
                const p = document.createElement('div');
                p.classList.add('explosion-particle');
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                p.style.setProperty('--color', p.style.backgroundColor);
                p.style.left = centerX + 'px';
                p.style.top = centerY + 'px';
                document.body.appendChild(p);

                const angle = Math.random() * Math.PI * 2;
                const velocity = 150 + Math.random() * 900; 
                const destX = Math.cos(angle) * velocity;
                const destY = Math.sin(angle) * velocity;
                const rotation = Math.random() * 720;

                p.animate([
                    { transform: `translate(0,0) scale(1) rotate(0deg)`, opacity: 1 },
                    { transform: `translate(${destX}px, ${destY}px) scale(0) rotate(${rotation}deg)`, opacity: 0 }
                ], { duration: 800 + Math.random() * 400, easing: 'cubic-bezier(0.25, 1, 0.5, 1)' }).onfinish = () => p.remove();
            }
        }

        function addToSidebar(name, msg) {
            const list = document.getElementById('messageList');
            const card = document.createElement('div');
            card.classList.add('msg-card');
            const now = new Date();
            card.innerHTML = `<div class="msg-name">${name}<span class="msg-time">${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}</span></div><div class="msg-content">${msg}</div>`;
            list.insertBefore(card, list.firstChild);
            if (list.children.length > 50) list.removeChild(list.lastChild);
        }

        function onMessageReceived(name, msg) {
            addToSidebar(name, msg);
            if (filledCount >= totalPieces) return;

            // === [關鍵邏輯] 判斷是否為長官 ===
            const isVipUser = name.includes("董事長") || name.includes("總經理");
            let targetIndex = -1;

            if (isVipUser) {
                // 如果是長官，優先找星星的位置
                targetIndex = getVipEmptyIndex();
                // 如果星星都滿了，則找一般位置 (避免長官沒地方填)
                if (targetIndex === -1) targetIndex = getRandomEmptyIndex();
            } else {
                // 一般人，只能找一般位置 (星星會被避開)
                targetIndex = getRandomEmptyIndex();
            }

            if (targetIndex !== -1) {
                const targetPiece = pieces[targetIndex];
                targetPiece.classList.add('active');
                filledCount++;
                
                // 傳入是否為 VIP 旗標，決定爆炸特效顏色
                triggerEnergyExplosion(targetPiece, isVipUser);
                showMarquee(`${name}：${msg}`);

                if (filledCount === totalPieces) {
                    setTimeout(() => {
                        document.getElementById('finalSlogan').style.opacity = 1;
                        triggerCompletionEffect();
                    }, 500);
                }
            }
        }

        function showMarquee(text) {
            const container = document.getElementById('marqueeArea');
            const el = document.createElement('div');
            el.classList.add('marquee-item');
            el.innerText = text;
            const colors = ['#fff', '#ffd700', '#7df9ff', '#ffb74d'];
            el.style.borderColor = colors[Math.floor(Math.random() * colors.length)];
            el.style.left = (5 + Math.random() * 80) + '%';
            container.appendChild(el);
            setTimeout(() => { el.remove(); }, 16000);
        }

        function triggerCompletionEffect() {
            pieces.forEach((p, i) => {
                setTimeout(() => {
                    p.style.transform = 'scale(1.5) translateZ(150px)';
                    p.style.boxShadow = '0 0 100px white, 0 0 150px var(--neon-cyan)';
                    p.style.zIndex = 200;
                    setTimeout(() => {
                        p.style.transform = 'scale(1.2) translateZ(50px)';
                         p.style.boxShadow = '0 0 30px var(--neon-cyan), 0 0 60px var(--kgi-bright-blue)';
                        p.style.zIndex = 100;
                    }, 600);
                }, (i % 9) * 60 + (Math.floor(i / 9) * 30));
            });
             document.querySelector('.title').style.animation = 'none';
             document.querySelector('.title').style.textShadow = '0 0 50px var(--kgi-orange), 0 0 100px var(--kgi-orange)';
        }

        const broker = "broker.emqx.io"; const port = 8084; const topic = "kgi_event_2025_live_demo";
        const clientID = "monitor_" + new Date().getTime();
        const client = new Paho.MQTT.Client(broker, port, clientID);
        client.onConnectionLost = function (res) { document.getElementById('statusDot').classList.remove('online'); document.getElementById('statusText').innerText = "連線中斷..."; setTimeout(connectMQTT, 2000); };
        client.onMessageArrived = function (msg) { try { const data = JSON.parse(msg.payloadString); onMessageReceived(data.name, data.msg); } catch (e) {} };
        function connectMQTT() {
            client.connect({ useSSL: true, onSuccess: function () { document.getElementById('statusDot').classList.add('online'); document.getElementById('statusText').innerText = `系統連線就緒`; client.subscribe(topic); }, onFailure: function () {} });
        }
        initBuilding(); connectMQTT();
    </script>
</body>
</html>
